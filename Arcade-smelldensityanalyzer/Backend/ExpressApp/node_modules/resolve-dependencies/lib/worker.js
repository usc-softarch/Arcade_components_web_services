"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const async_1 = require("@calebboyd/async");
class WorkerThread {
    constructor({ taskConccurency = 10 } = {}) {
        this.pending = {};
        this.child = child_process_1.fork(require.resolve('./worker-runtime'));
        this.lock = new async_1.Semaphore(taskConccurency);
        this.child.on('message', (message) => {
            this.lock.release();
            const waiter = this.pending[message.id];
            delete this.pending[message.id];
            if (message.error) {
                waiter.reject(new Error(message.error));
            }
            else {
                waiter.resolve(message.result);
            }
        });
    }
    sendMessage(message) {
        return this.lock.acquire().then((id) => {
            this.child.send({ id, ...message });
            return (this.pending[id] = async_1.createDeferred()).promise;
        });
    }
    end() {
        this.child.kill();
    }
}
exports.WorkerThread = WorkerThread;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3dvcmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFvQztBQUVwQyw0Q0FBc0U7QUFRdEUsTUFBYSxZQUFZO0lBSXZCLFlBQVksRUFBRSxlQUFlLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRTtRQUZqQyxZQUFPLEdBQTRELEVBQUUsQ0FBQTtRQUNyRSxVQUFLLEdBQUcsb0JBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQTtRQUV2RCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksaUJBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxPQUFtQixFQUFFLEVBQUU7WUFDL0MsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUNuQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUN2QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQy9CLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtnQkFDakIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTthQUN4QztpQkFBTTtnQkFDTCxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTthQUMvQjtRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFnQjtRQUMxQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBVSxFQUFFLEVBQUU7WUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQyxDQUFBO1lBQ25DLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHNCQUFjLEVBQThCLENBQUMsQ0FBQyxPQUFPLENBQUE7UUFDbEYsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsR0FBRztRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDbkIsQ0FBQztDQUNGO0FBNUJELG9DQTRCQyJ9
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const file_1 = require("./file");
const path_1 = require("path");
const worker_1 = require("./worker");
const node_builtins_1 = __importDefault(require("./node-builtins"));
const os_1 = require("os");
class Loader {
    constructor(options) {
        var _a;
        this.options = options;
        this.pool = [];
        this.ended = false;
        this.currentWorker = 0;
        const cores = ((_a = os_1.cpus()) !== null && _a !== void 0 ? _a : []).length;
        this.size = Number(process.env.RESOLVE_DEPENDENCIES_CPUS) || (cores > 2 ? cores - 1 : 1);
        this.starting = [...Array(this.size)].map((x) => new worker_1.WorkerThread({ taskConccurency: 100 }));
        this.workerOptions = { ...options, files: {} };
    }
    setup() {
        if (this.initializing) {
            return this.initializing;
        }
        this.ended = false;
        //initailize all, but only wait for the first one
        return (this.initializing = Promise.race(this.starting.map((x) => {
            return x
                .sendMessage({
                modulePath: require.resolve('./node-loader'),
                contextName: 'node-loader',
                options: this.workerOptions,
            })
                .then(() => {
                if (this.ended) {
                    x.end();
                }
                this.pool.push(x);
            });
        })).then(() => undefined));
    }
    quit() {
        this.ended = true;
        this.pool.forEach((x) => x.end());
    }
    getWorker() {
        //todo wait for workers to warm up
        const worker = this.pool[this.currentWorker++];
        if (this.currentWorker === this.pool.length) {
            this.currentWorker = 0;
        }
        return worker;
    }
    loadEntry(workingDirectory, request, files = {}, warnings = []) {
        const mainFile = file_1.ensureDottedRelative(workingDirectory, path_1.resolve(workingDirectory, request));
        return this.load(workingDirectory, mainFile, files, warnings).then((entry) => {
            return { entry, files, warnings };
        }, (e) => {
            throw e;
        });
    }
    async load(cd, request, files = {}, warnings, context) {
        const worker = this.getWorker();
        const options = {};
        if (context) {
            Object.assign(options, this.workerOptions, { context });
        }
        else {
            Object.assign(options, this.workerOptions);
        }
        const file = await worker.sendMessage({
            contextName: 'node-loader',
            method: 'load',
            args: [cd, request, options],
        });
        if ('warning' in file) {
            warnings.push(file.warning);
            return null;
        }
        if (files[file.absPath] !== undefined) {
            return files[file.absPath];
        }
        else {
            files[file.absPath] = file;
        }
        let packageGlobs = undefined;
        if (file.moduleRoot && file.package && file.package.files) {
            packageGlobs = file.package.files;
        }
        if (!packageGlobs && file.belongsTo && file.belongsTo.package && file.belongsTo.package.files) {
            packageGlobs = file.belongsTo.package.files;
        }
        const fileDir = path_1.dirname(file.absPath);
        const ctx = {
            moduleRoot: file.moduleRoot || (file.belongsTo && file.belongsTo.moduleRoot) || undefined,
            package: file.package,
            expanded: Boolean(file.contextExpanded),
            globs: packageGlobs,
        };
        await Promise.all(Object.keys(file.deps).map((req) => {
            if (~node_builtins_1.default.indexOf(req)) {
                return (file.deps[req] = null);
            }
            return this.load(fileDir, req, files, warnings, ctx).then((dep) => {
                file.deps[req] = dep;
                if ((file.moduleRoot || file.belongsTo) && dep && !dep.moduleRoot) {
                    const owner = file.moduleRoot ? file : file.belongsTo;
                    dep.belongsTo = owner;
                }
            });
        }));
        return file;
    }
}
exports.Loader = Loader;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLXBvb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbG9hZGVyLXBvb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpQ0FBNkU7QUFDN0UsK0JBQXVDO0FBQ3ZDLHFDQUF1QztBQUN2QyxvRUFBc0M7QUFDdEMsMkJBQXlCO0FBS3pCLE1BQWEsTUFBTTtJQVNqQixZQUFvQixPQUEwQjs7UUFBMUIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFSdEMsU0FBSSxHQUFtQixFQUFFLENBQUE7UUFFekIsVUFBSyxHQUFHLEtBQUssQ0FBQTtRQUdiLGtCQUFhLEdBQUcsQ0FBQyxDQUFBO1FBSXZCLE1BQU0sS0FBSyxHQUFHLE9BQUMsU0FBSSxFQUFFLG1DQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN4RixJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLHFCQUFZLENBQUMsRUFBRSxlQUFlLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzVGLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLENBQUE7SUFDaEQsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFBO1NBQ3pCO1FBQ0QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENB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